

      subroutine detmt3 (n, a, ipiv, redet, imdet, mult)

      implicit none


C +------------------------------------------------------------+
C |  detmt3   --   RSS, 06.2013                                |
C |                                                            |
C |                                    (based on PHFB detmat)  |
C |                                                            |
C |                                                            |
C |  Compute complex determinant of a SQUARE, COMPLEX matrix   |
C |  A (dimension n x n), from its LU decomposition.           |
C |                                                            |
C |  In particular, detmat uses the LU decomposition with      |
C |  pivoting generated by the LaPack routine zgetrf. The      |
C |  LU decomposition is returned by LaPack in a single        |
C |  matrix, where the lower triangle corresponds to L and     |
C |  the upper triangle (including the diagonal) corresponds   |
C |  to U. Note that the diagonal unit elements corresponding  |
C |  to L are not stored anywhere.                             |
C |                                                            |
C |  The LU decomposition generated by LaPack then reads       |
C |    A = P . L . U,                                          |
C |                                                            |
C |  where P is the permutation matrix (can be recovered       |
C |  from the pivoting indices), and L and U are the lower     |
C |  and upper triangular matrices.                            |
C |                                                            |
C |  The determinant of the matrix A can then be easily        |
C |  computed as                                               |
C |                                                            |
C |    det(A) = det(P) . det(L) . det(U)                       |
C |                                                            |
C |  det(L) and det(U) are easily computed since they are      |
C |  triangular matrices. The determinant of the triangular    |
C |  matrix T is given by                                      |
C |                                                            |
C |    det (T) = prod_{i=1,n}  T(i,i)                          |
C |                                                            |
C |  Hence, det(L) = 1 (all diagonal elements are 1), and      |
C |  needs not be computed. Additionally, det(P) = +/- 1,      |
C |  depending on the signature of the permutation, due to     |
C |  the fact that it is a permutation matrix.                 |
C |                                                            |
C |  Therefore, detmat computes the determinant of A as        |
C |                                                            |
C |    det(A) = +/- 1 * det(U)                                 |
C |                                                            |
C +------------------------------------------------------------+


C     input / output variables

C       n     - leading dimension of matrix a
C       a     - LU decomposition of matrix a (generated by LaPack)
C       ipiv  - vector of pivoting indices (as generated by LaPack)
C       redet - real part of determinant [ out ]
C       imdet - imaginary part of determinant [ out ]
C       mult  - whether to return the value of the determinant of to multiply
C               it to the value provided. FALSE - compute the determinant,
C               TRUE - multiply

      real*8      redet, imdet
      integer     n, ipiv(*)
      complex*16  a(n,*)
      logical     mult

C     other variables

      integer     i, sgn
      complex*16  x

C     Determine the overall sign of the determinant from the permutation
C     matrix.

      sgn = 1

      do 10 i = 1, n
        if ( ipiv(i) .ne. i ) sgn = -sgn
 10   continue

C     Initialize 

      if ( mult ) then
         x = cmplx (redet,imdet)
         x = cmplx (1.0d0,0.0d0)
      endif

C     Loop over diagonal elements of the upper matrix.

      do 20 i = 1, n

C     Recover real and imaginary part of a(i,i).

        x = x*a(i,i)

        redet = dble (x)
        imdet = aimag (x)
 20   continue

      return
      end
